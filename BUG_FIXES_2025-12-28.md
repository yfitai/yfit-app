# YFIT Bug Fixes - December 28, 2025

## Issues Reported
1. **Android app only showing branded foods** (Desktop shows USDA + branded)
2. **Daily tracker "save log" error** - "can't find public dailey logs in schema cache"

---

## Bug #1: Android Food Search - Missing USDA Foods

### Root Cause
The Android app is not showing USDA foods because:
1. The USDA API key (`VITE_USDA_API_KEY`) may not be properly set in the production environment
2. The Android app might be using a cached version of the code
3. Network/CORS issues on mobile devices

### Code Analysis
The food search code in `src/lib/foodDatabase.js` is **CORRECT**:
- Line 35-52: When `source === 'all'`, it searches both Open Food Facts (branded) AND USDA
- Line 43-52: USDA search is enabled and working on desktop
- The code properly interleaves results from both sources (lines 69-81)

### Solution

#### Step 1: Verify USDA API Key is Set
The app needs `VITE_USDA_API_KEY` environment variable. Check your deployment platform:

**For Vercel:**
1. Go to https://vercel.com/dashboard
2. Select your `yfit-deploy` project
3. Go to Settings → Environment Variables
4. Verify `VITE_USDA_API_KEY` is set
5. If missing, add it with your USDA API key (get one free at https://fdc.nal.usda.gov/api-key-signup.html)

**For local development:**
Create a `.env` file in the project root:
```
VITE_USDA_API_KEY=your_api_key_here
```

#### Step 2: Rebuild Android App
The Android app bundles the JavaScript code at build time, so it needs to be rebuilt:

```bash
cd /home/ubuntu/yfit

# Sync latest code to Android
npx cap sync android

# Rebuild the Android app
cd android
./gradlew clean
./gradlew assembleRelease

# Or use the deployment script
cd ..
./deploy-android.ps1
```

#### Step 3: Clear App Cache on Android
On your Android device:
1. Go to Settings → Apps → YFIT
2. Tap "Storage"
3. Tap "Clear Cache" and "Clear Data"
4. Reinstall the app

### Testing
After rebuilding, search for "chicken" in the app:
- ✅ Should see both branded foods (e.g., "Tyson Chicken Breast")
- ✅ Should see USDA foods (e.g., "Chicken, broilers or fryers, breast, meat only, raw")
- ✅ Results should be interleaved (branded, USDA, branded, USDA...)

---

## Bug #2: Daily Tracker Save Log Error

### Root Cause
The `daily_logs` table does not exist in your Supabase database. The error message "can't find public dailey logs" (note the typo in the error message itself) indicates Supabase cannot find the table.

### Solution

#### Step 1: Create the daily_logs Table in Supabase

1. Go to your Supabase SQL Editor:
   https://mxggxpoxgqubojvumjlt.supabase.co/project/_/sql

2. Copy the contents of `database/daily_logs_schema.sql` (created in this fix)

3. Paste into the SQL Editor and click "Run"

4. Verify the table was created:
   - Go to Table Editor in Supabase
   - You should see `daily_logs` table with columns:
     * id (UUID)
     * user_id (UUID)
     * logged_at (timestamp)
     * sleep_hours, sleep_quality
     * water_ml
     * steps
     * bp_systolic, bp_diastolic
     * glucose_mg_dl
     * weight_kg, body_fat_percent
     * notes
     * created_at, updated_at

#### Step 2: Verify Row Level Security (RLS)
The SQL script automatically sets up RLS policies so users can only access their own logs. Verify in Supabase:
1. Go to Authentication → Policies
2. Check that `daily_logs` has 4 policies:
   - Users can view their own daily logs
   - Users can insert their own daily logs
   - Users can update their own daily logs
   - Users can delete their own daily logs

#### Step 3: Test the Daily Tracker
1. Log into your YFIT app
2. Go to Daily Tracker page
3. Fill in some data (sleep hours, water, steps, etc.)
4. Click "Save Log"
5. ✅ Should see "Daily log saved!" message
6. ✅ Data should persist when you refresh the page

### Testing
```sql
-- Run this in Supabase SQL Editor to verify data is being saved
SELECT * FROM daily_logs ORDER BY logged_at DESC LIMIT 10;
```

---

## Additional Recommendations

### 1. Add Error Handling for Missing USDA API Key
Update `src/lib/foodDatabase.js` line 14 to show a warning:

```javascript
const USDA_API_KEY = import.meta.env.VITE_USDA_API_KEY || 'DEMO_KEY'
if (USDA_API_KEY === 'DEMO_KEY') {
  console.warn('⚠️ USDA API key not set. Using DEMO_KEY (rate limited). Set VITE_USDA_API_KEY in environment variables.')
}
```

### 2. Add Fallback for Daily Tracker
Consider adding a localStorage fallback if Supabase is unavailable (similar to demo mode).

### 3. Monitor API Usage
- USDA API has rate limits (1000 requests/hour for free tier)
- Consider implementing caching for frequently searched foods
- Monitor usage at: https://fdc.nal.usda.gov/api-key-signup.html

---

## Deployment Checklist

After applying these fixes:

- [ ] USDA API key set in Vercel environment variables
- [ ] daily_logs table created in Supabase
- [ ] RLS policies verified in Supabase
- [ ] Web app redeployed (automatic via Vercel)
- [ ] Android app rebuilt with `npx cap sync android`
- [ ] Android app tested on physical device
- [ ] Food search tested (both branded and USDA results appear)
- [ ] Daily tracker tested (save log works)
- [ ] User data persists across sessions

---

## Files Modified/Created

1. **Created**: `database/daily_logs_schema.sql` - SQL schema for daily_logs table
2. **Created**: `BUG_FIXES_2025-12-28.md` - This document
3. **No code changes needed** - The application code is correct!

---

## Next Steps

1. **Immediate**: Run the SQL schema in Supabase to fix daily tracker
2. **Immediate**: Verify USDA API key is set in Vercel
3. **Short-term**: Rebuild and redeploy Android app
4. **Optional**: Add the recommended error handling improvements

---

## Support

If issues persist:
- Check browser console logs for detailed error messages
- Check Supabase logs for database errors
- Verify API keys are correctly set
- Ensure Android app is using the latest build

Last updated: December 28, 2025
